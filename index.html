<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tor21Miner</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            -webkit-user-select: none;
            user-select: none;
        }
        #stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('images/background.png') repeat;
            animation: stars 100s linear infinite;
            z-index: -1;
        }
        @keyframes stars {
            from { background-position: 0 0; }
            to { background-position: -10000px -10000px; }
        }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            z-index: 10;
        }
        #miner-info {
            position: absolute;
            top: 40px;
            left: 10px;
            font-size: 14px;
            z-index: 10;
        }
        #tap-area {
            width: 200px;
            height: 200px;
            background: url('images/2rt_logo.png') no-repeat center;
            background-size: contain;
            cursor: pointer;
            transition: transform 0.1s;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        #tap-area:hover, #tap-area:active {
            transform: scale(1.05);
        }
        #ship-area {
            position: absolute;
            left: 10px;
            bottom: 80px;
            width: 80px;
            height: 80px;
            background: url('images/spaceship_basic.png') no-repeat center;
            background-size: contain;
            z-index: 5;
        }
        .menu {
            position: absolute;
            bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            z-index: 10;
        }
        .button {
            background: linear-gradient(45deg, #ff6f61, #e94560);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .button:hover, .button:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 7px rgba(0, 0, 0, 0.4);
        }
        #energy-bar {
            width: 150px;
            height: 15px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
            z-index: 5;
        }
        #energy-fill {
            height: 100%;
            background: #00ff99;
            transition: width 0.5s;
        }
        #tasks {
            position: absolute;
            top: 80px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 10px;
            font-size: 14px;
            max-width: 150px;
            z-index: 10;
        }
        #ranking {
            position: absolute;
            top: 80px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 10px;
            font-size: 14px;
            max-width: 150px;
            z-index: 10;
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="stars"></div>
    <div id="hud">
        <span id="points">Puntos: 0</span>
        <span id="ship">Nave: Basic</span>
        <span id="invites">Invitados: 0</span>
    </div>
    <div id="miner-info">Minero Espacial: @<span id="username"></span><br>Wallet: <span id="wallet">No registrado</span></div>
    <div id="tasks">
        <h3>Tareas</h3>
        <p id="task-social">Unirse a Comunidad: 0/1</p>
        <p id="task-share">Compartir Info: 0/1</p>
    </div>
    <div id="ranking">
        <h3>Top Mineros</h3>
        <p id="top-list">1. MineroX: 100,000<br>2. AstroY: 80,000<br>3. SpaceZ: 50,000</p>
    </div>
    <div id="tap-area"></div>
    <div id="ship-area"></div>
    <div id="energy-bar"><div id="energy-fill" style="width: 100%;"></div></div>
    <div class="menu">
        <button class="button" id="upgrade-btn">Mejorar Nave</button>
        <button class="button" id="wallet-btn">Registrar Wallet</button>
        <button class="button" id="buy-btn">Comprar 2RT</button>
        <button class="button" id="affiliate-btn">Afiliados</button>
        <button class="button" id="community-btn">Unirse a Comunidad</button>
        <button class="button" id="share-btn">Compartir Info</button>
    </div>
    <script>
        (function() {
            console.log("Iniciando mini app...");

            // Variables globales
            let userId, username, gameData, points, ship, invites, energy, maxEnergy, tasks, wallet;
            const tapMultiplier = { "Basic": 1, "Bronze": 2, "Silver": 5, "Gold": 10 };

            // Verificar si es un teléfono móvil
            function isMobileDevice() {
                const userAgent = navigator.userAgent.toLowerCase();
                return /mobile|android|iphone|ipod/.test(userAgent) && !/tablet|ipad/.test(userAgent);
            }

            // Inicializar la mini app
            function initMiniApp() {
                try {
                    console.log("Esperando inicialización de Telegram Web App...");
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                    console.log("Telegram Web App inicializado");

                    // Verificar si estamos en Telegram
                    if (!Telegram.WebApp.initDataUnsafe || !Telegram.WebApp.initDataUnsafe.user) {
                        document.body.innerHTML = "<h1>Esta aplicación solo funciona en Telegram desde un teléfono móvil</h1>";
                        console.error("No se está ejecutando en Telegram");
                        return;
                    }

                    // Verificar si es un teléfono móvil
                    if (!isMobileDevice()) {
                        document.body.innerHTML = "<h1>Esta aplicación solo funciona en teléfonos móviles con Telegram</h1>";
                        console.error("Dispositivo no es un teléfono móvil");
                        return;
                    }

                    userId = Telegram.WebApp.initDataUnsafe.user.id;
                    username = Telegram.WebApp.initDataUnsafe.user.username || "Anonimo";
                    console.log("Usuario:", userId, username);

                    // Cargar datos del juego desde localStorage
                    gameData = JSON.parse(localStorage.getItem(`tor21miner_${userId}`)) || {
                        points: 0,
                        ship: "Basic",
                        invites: 0,
                        energy: 100,
                        maxEnergy: 100,
                        tasks: { social: false, share: false },
                        wallet: null
                    };
                    console.log("Datos cargados:", gameData);

                    points = gameData.points;
                    ship = gameData.ship;
                    invites = gameData.invites;
                    energy = gameData.energy;
                    maxEnergy = gameData.maxEnergy;
                    tasks = gameData.tasks;
                    wallet = gameData.wallet;

                    // Actualizar HUD y tareas
                    updateUI();

                    // Vincular eventos
                    document.getElementById("tap-area").addEventListener("click", tap);
                    document.getElementById("upgrade-btn").addEventListener("click", upgradeShip);
                    document.getElementById("wallet-btn").addEventListener("click", connectWallet);
                    document.getElementById("buy-btn").addEventListener("click", buyTokens);
                    document.getElementById("affiliate-btn").addEventListener("click", showAffiliate);
                    document.getElementById("community-btn").addEventListener("click", joinCommunity);
                    document.getElementById("share-btn").addEventListener("click", shareInfo);
                    console.log("Eventos vinculados");

                    // Recarga de energía
                    setInterval(() => {
                        if (energy < maxEnergy) {
                            energy += 1;
                            updateEnergyBar();
                            saveGameData();
                            console.log("Energía recargada:", energy);
                        }
                    }, 60000);
                } catch (e) {
                    console.error("Error en initMiniApp:", e);
                    Telegram.WebApp.showAlert("Error al iniciar: " + e.message);
                }
            }

            // Guardar datos en localStorage
            function saveGameData() {
                try {
                    gameData = { points, ship, invites, energy, maxEnergy, tasks, wallet };
                    localStorage.setItem(`tor21miner_${userId}`, JSON.stringify(gameData));
                    console.log("Datos guardados:", gameData);
                } catch (e) {
                    console.error("Error al guardar datos:", e);
                }
            }

            // Actualizar UI
            function updateUI() {
                try {
                    document.getElementById("points").innerHTML = `Puntos: ${points}`;
                    document.getElementById("ship").innerHTML = `Nave: ${ship}`;
                    document.getElementById("invites").innerHTML = `Invitados: ${invites}`;
                    document.getElementById("username").innerHTML = username;
                    document.getElementById("wallet").innerHTML = wallet ? `${wallet.slice(0, 6)}...${wallet.slice(-4)}` : "No registrado";
                    document.getElementById("task-social").innerHTML = `Unirse a Comunidad: ${tasks.social ? '1/1' : '0/1'}`;
                    document.getElementById("task-share").innerHTML = `Compartir Info: ${tasks.share ? '1/1' : '0/1'}`;
                    updateShipImage();
                    updateEnergyBar();
                    console.log("UI actualizada");
                } catch (e) {
                    console.error("Error en updateUI:", e);
                }
            }

            function tap() {
                console.log("Botón Tap presionado");
                try {
                    if (!wallet) {
                        Telegram.WebApp.showAlert("¡Registra tu wallet para jugar!");
                        return;
                    }
                    if (energy > 0) {
                        energy -= 1;
                        let earned = tapMultiplier[ship];
                        points += earned;
                        updateUI();
                        Telegram.WebApp.showAlert(`¡Minaste ${earned} puntos!`);
                        saveGameData();
                    } else {
                        Telegram.WebApp.showAlert("¡Sin energía! Espera a que se recargue.");
                    }
                } catch (e) {
                    console.error("Error en tap:", e);
                    Telegram.WebApp.showAlert("Error al minar: " + e.message);
                }
            }

            function updateEnergyBar() {
                document.getElementById("energy-fill").style.width = `${(energy / maxEnergy) * 100}%`;
            }

            function updateShipImage() {
                const shipImages = {
                    "Basic": "images/spaceship_basic.png",
                    "Bronze": "images/spaceship_bronze.png",
                    "Silver": "images/spaceship_silver.png",
                    "Gold": "images/spaceship_gold.png"
                };
                document.getElementById("ship-area").style.background = `url('${shipImages[ship]}') no-repeat center`;
                document.getElementById("ship-area").style.backgroundSize = "contain";
            }

            function upgradeShip() {
                console.log("Botón Mejorar Nave presionado");
                try {
                    if (!wallet) {
                        Telegram.WebApp.showAlert("¡Registra tu wallet para jugar!");
                        return;
                    }
                    if (ship === "Basic" && points >= 5000) {
                        ship = "Bronze";
                        points -= 5000;
                        Telegram.WebApp.showAlert("¡Nave mejorada a Bronce! +2 puntos por tap.");
                    } else if (ship === "Bronze" && points >= 20000 && invites >= 5) {
                        ship = "Silver";
                        points -= 20000;
                        Telegram.WebApp.showAlert("¡Nave mejorada a Plata! +5 puntos por tap.");
                    } else if (ship === "Silver" && points >= 50000 && invites >= 10) {
                        ship = "Gold";
                        points -= 50000;
                        Telegram.WebApp.showAlert("¡Nave mejorada a Oro! +10 puntos por tap.");
                    } else if (ship === "Gold" && points >= 100000 && invites >= 15) {
                        Telegram.WebApp.showAlert("¡Ya tienes la mejor nave posible!");
                    } else {
                        let req = "";
                        if (ship === "Basic") req = "5,000 puntos";
                        else if (ship === "Bronze") req = "20,000 puntos y 5 invitados";
                        else if (ship === "Silver") req = "50,000 puntos y 10 invitados";
                        else if (ship === "Gold") req = "100,000 puntos y 15 invitados";
                        Telegram.WebApp.showAlert(`Necesitas: ${req}`);
                    }
                    updateUI();
                    saveGameData();
                } catch (e) {
                    console.error("Error en upgradeShip:", e);
                    Telegram.WebApp.showAlert("Error al mejorar nave: " + e.message);
                }
            }

            function connectWallet() {
                console.log("Botón Registrar Wallet presionado");
                try {
                    if (wallet) {
                        Telegram.WebApp.showAlert(`Wallet ya registrada para el juego: ${wallet}`);
                        return;
                    }
                    Telegram.WebApp.showPopup({
                        title: "Registrar Wallet para Jugar",
                        message: "Ingresa tu dirección Polygon:",
                        buttons: [
                            { id: "submit", type: "default", text: "Enviar" },
                            { type: "cancel", text: "Cancelar" }
                        ]
                    }, (buttonId) => {
                        if (buttonId === "submit") {
                            let newWallet = prompt("Dirección Polygon:");
                            if (newWallet) {
                                wallet = newWallet;
                                updateUI();
                                Telegram.WebApp.showAlert("¡Wallet registrada para jugar!");
                                saveGameData();
                            }
                        }
                    });
                } catch (e) {
                    console.error("Error en connectWallet:", e);
                    Telegram.WebApp.showAlert("Error al registrar wallet: " + e.message);
                }
            }

            function buyTokens() {
                console.log("Botón Comprar 2RT presionado");
                try {
                    Telegram.WebApp.sendData(`/buy_menu ${userId}`);
                    Telegram.WebApp.showAlert("Redirigiendo al bot para comprar 2RT...");
                } catch (e) {
                    console.error("Error en buyTokens:", e);
                    Telegram.WebApp.showAlert("Error al redirigir para comprar: " + e.message);
                }
            }

            function showAffiliate() {
                console.log("Botón Afiliados presionado");
                try {
                    Telegram.WebApp.sendData(`/affiliate ${userId}`);
                    Telegram.WebApp.showAlert("Consulta tu enlace de afiliado en el chat del bot.");
                    invites += 1;
                    updateUI();
                    saveGameData();
                } catch (e) {
                    console.error("Error en showAffiliate:", e);
                    Telegram.WebApp.showAlert("Error al mostrar afiliados: " + e.message);
                }
            }

            function joinCommunity() {
                console.log("Botón Unirse a Comunidad presionado");
                try {
                    if (tasks.social) {
                        Telegram.WebApp.showAlert("¡Ya te uniste a la comunidad!");
                        return;
                    }
                    window.open("https://t.me/torr21_2RT", "_blank");
                    tasks.social = true;
                    points += 5000;
                    updateUI();
                    Telegram.WebApp.showAlert("¡Unido a la comunidad! +5,000 puntos.");
                    saveGameData();
                } catch (e) {
                    console.error("Error en joinCommunity:", e);
                    Telegram.WebApp.showAlert("Error al unirse a la comunidad: " + e.message);
                }
            }

            function shareInfo() {
                console.log("Botón Compartir Info presionado");
                try {
                    if (tasks.share) {
                        Telegram.WebApp.showAlert("¡Ya compartiste la info!");
                        return;
                    }
                    Telegram.WebApp.showPopup({
                        title: "Compartir Info",
                        message: "Comparte Tor21Miner con tus amigos:",
                        buttons: [{ type: "ok", text: "OK" }]
                    });
                    tasks.share = true;
                    points += 5000;
                    updateUI();
                    Telegram.WebApp.showAlert("¡Info compartida! +5,000 puntos.");
                    saveGameData();
                } catch (e) {
                    console.error("Error en shareInfo:", e);
                    Telegram.WebApp.showAlert("Error al compartir info: " + e.message);
                }
            }

            // Iniciar la mini app
            initMiniApp();
        })();
    </script>
</body>
</html>