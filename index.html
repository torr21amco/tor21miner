<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tor21Miner</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            -webkit-user-select: none; /* Evita selección */
            user-select: none;
        }
        #stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('images/background.png') repeat;
            animation: stars 100s linear infinite;
            z-index: -1;
        }
        @keyframes stars {
            from { background-position: 0 0; }
            to { background-position: -10000px -10000px; }
        }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 16px; /* Reducido para móviles */
            z-index: 10;
        }
        #tap-area {
            width: 200px; /* Reducido para móviles */
            height: 200px;
            background: url('images/2rt_logo.png') no-repeat center;
            background-size: contain;
            cursor: pointer;
            transition: transform 0.1s;
            outline: none; /* Elimina borde al tocar */
            -webkit-tap-highlight-color: transparent; /* Elimina resaltado en móviles */
        }
        #tap-area:hover, #tap-area:active {
            transform: scale(1.05);
        }
        #ship-area {
            position: absolute;
            left: 10px;
            bottom: 80px; /* Ajustado para no solaparse con menú */
            width: 80px; /* Reducido para móviles */
            height: 80px;
            background: url('images/spaceship_basic.png') no-repeat center;
            background-size: contain;
            z-index: 5;
        }
        .menu {
            position: absolute;
            bottom: 10px;
            display: flex;
            flex-wrap: wrap; /* Ajuste en pantallas pequeñas */
            gap: 5px; /* Reducido para más espacio */
            justify-content: center;
            z-index: 10;
        }
        .button {
            background: linear-gradient(45deg, #ff6f61, #e94560);
            color: white;
            padding: 8px 15px; /* Reducido para móviles */
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px; /* Reducido para móviles */
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .button:hover, .button:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 7px rgba(0, 0, 0, 0.4);
        }
        #energy-bar {
            width: 150px; /* Reducido para móviles */
            height: 15px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
            z-index: 5;
        }
        #energy-fill {
            height: 100%;
            background: #00ff99;
            transition: width 0.5s;
        }
        #tasks {
            position: absolute;
            top: 50px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 10px;
            font-size: 14px; /* Reducido para móviles */
            max-width: 150px; /* Limita ancho para evitar solapamiento */
            z-index: 10;
        }
        #ranking {
            position: absolute;
            top: 50px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 10px;
            font-size: 14px;
            max-width: 150px;
            z-index: 10;
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="stars"></div>
    <div id="hud">
        <span id="points">Puntos: 0</span>
        <span id="ship">Nave: Basic</span>
        <span id="invites">Invitados: 0</span>
    </div>
    <div id="tasks">
        <h3>Tareas</h3>
        <p id="task-wallet">Conectar Wallet: 0/1</p>
        <p id="task-buy">Comprar 2RT: 0/1</p>
        <p id="task-social">Unirse a Comunidad: 0/1</p>
    </div>
    <div id="ranking">
        <h3>Top Mineros</h3>
        <p id="top-list">Cargando...</p>
    </div>
    <div id="tap-area" onclick="tap()"></div>
    <div id="ship-area"></div>
    <div id="energy-bar"><div id="energy-fill" style="width: 100%;"></div></div>
    <div class="menu">
        <button class="button" onclick="upgradeShip()">Mejorar Nave</button>
        <button class="button" onclick="connectWallet()">Registrar Wallet</button>
        <button class="button" onclick="buyTokens()">Comprar 2RT</button>
        <button class="button" onclick="showAffiliate()">Afiliados</button>
    </div>
    <script>
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        const userId = Telegram.WebApp.initDataUnsafe.user.id;
        let points = 0;
        let ship = "Basic";
        let invites = 0;
        let energy = 100;
        let maxEnergy = 100;
        let tapMultiplier = { "Basic": 1, "Bronze": 2, "Silver": 5, "Gold": 10 };
        let tasks = { wallet: false, buy: false, social: false };

        fetchStatus();

        setInterval(() => {
            if (energy < maxEnergy) {
                energy += 1;
                updateEnergyBar();
            }
        }, 60000);

        function fetchStatus() {
            Telegram.WebApp.sendData(`/status ${userId}`);
            Telegram.WebApp.onEvent('mainButtonClicked', updateStatus);
        }

        function updateStatus() {
            let data = Telegram.WebApp.mainButton.text.split('|');
            points = parseInt(data[0]);
            ship = data[1];
            invites = parseInt(data[2]);
            tasks.wallet = data[3] === "True";
            tasks.buy = data[4] === "True";
            tasks.social = data[5] === "True";
            document.getElementById("points").innerHTML = `Puntos: ${points}`;
            document.getElementById("ship").innerHTML = `Nave: ${ship}`;
            document.getElementById("invites").innerHTML = `Invitados: ${invites}`;
            document.getElementById("task-wallet").innerHTML = `Conectar Wallet: ${tasks.wallet ? '1/1' : '0/1'}`;
            document.getElementById("task-buy").innerHTML = `Comprar 2RT: ${tasks.buy ? '1/1' : '0/1'}`;
            document.getElementById("task-social").innerHTML = `Unirse a Comunidad: ${tasks.social ? '1/1' : '0/1'}`;
            updateShipImage();
            fetchRanking();
        }

        function tap() {
            if (energy > 0) {
                energy -= 1;
                let earned = tapMultiplier[ship];
                points += earned;
                Telegram.WebApp.sendData(`/tap ${userId}`);
                document.getElementById("points").innerHTML = `Puntos: ${points}`;
                updateEnergyBar();
                Telegram.WebApp.showAlert(`¡Minaste ${earned} puntos!`);
            } else {
                Telegram.WebApp.showAlert("¡Sin energía! Espera a que se recargue.");
            }
        }

        function updateEnergyBar() {
            document.getElementById("energy-fill").style.width = `${(energy / maxEnergy) * 100}%`;
        }

        function updateShipImage() {
            const shipImages = {
                "Basic": "images/spaceship_basic.png",
                "Bronze": "images/spaceship_bronze.png",
                "Silver": "images/spaceship_silver.png",
                "Gold": "images/spaceship_gold.png"
            };
            document.getElementById("ship-area").style.background = `url('${shipImages[ship]}') no-repeat center`;
            document.getElementById("ship-area").style.backgroundSize = "contain";
        }

        function upgradeShip() {
            Telegram.WebApp.sendData(`/upgrade ${userId}`);
            Telegram.WebApp.showAlert("Solicitando mejora de nave...");
        }

        function connectWallet() {
            Telegram.WebApp.showPopup({
                title: "Registrar Wallet",
                message: "Ingresa tu dirección Polygon:",
                buttons: [
                    { id: "submit", type: "default", text: "Enviar" },
                    { type: "cancel", text: "Cancelar" }
                ]
            }, (buttonId) => {
                if (buttonId === "submit") {
                    let wallet = prompt("Dirección Polygon:");
                    if (wallet) {
                        Telegram.WebApp.sendData(`/wallet ${userId} ${wallet}`);
                        Telegram.WebApp.showAlert("Wallet enviada para registro.");
                    }
                }
            });
        }

        function buyTokens() {
            Telegram.WebApp.sendData(`/buy_menu ${userId}`);
            Telegram.WebApp.showAlert("Abriendo menú de compra...");
        }

        function showAffiliate() {
            Telegram.WebApp.sendData(`/affiliate ${userId}`);
            Telegram.WebApp.showAlert("Mostrando enlace de afiliado...");
        }

        function fetchRanking() {
            document.getElementById("top-list").innerHTML = "1. MineroX: 100,000\n2. AstroY: 80,000\n3. SpaceZ: 50,000";
        }
    </script>
</body>
</html>